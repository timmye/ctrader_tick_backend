(function(){"use strict";console.log("Worker started");let o={},e={},l;const f={calm:{baseInterval:2e3,randomness:1500,magnitudeMultiplier:.5,momentumStrength:.05,meanReversionPoint:.7},normal:{baseInterval:800,randomness:1e3,magnitudeMultiplier:1,momentumStrength:.1,meanReversionPoint:.7},active:{baseInterval:300,randomness:400,magnitudeMultiplier:1.5,momentumStrength:.15,meanReversionPoint:.6},volatile:{baseInterval:100,randomness:200,magnitudeMultiplier:2,momentumStrength:.2,meanReversionPoint:.5}};function v(){const t=performance.now(),n=f[o.frequencyMode];if(!n||!e||t-e.lastTickTime<n.baseInterval+Math.random()*n.randomness)return;e.momentum=(e.momentum||0)*.85;let i=e.momentum*n.momentumStrength;Math.abs(e.momentum)>n.meanReversionPoint&&(i*=-.5);const s=Math.random()<.5+i?1:-1;e.momentum=Math.max(-1,Math.min(1,e.momentum+s*.25));const m=Math.random();let c=m<.8?Math.random()*.8:m<.98?.8+Math.random()*2:3+Math.random()*5;c*=n.magnitudeMultiplier;const a=e.currentPrice+s*c/1e4;e.currentPrice=a,e.lastTickTime=t,e.lastTickDirection=s;const r={magnitude:c,direction:s,price:a,time:t};e.ticks.push(r),e.allTicks.push(r),e.minObservedPrice=Math.min(e.minObservedPrice,a),e.maxObservedPrice=Math.max(e.maxObservedPrice,a),P(r)}function P(t){if(!e||!e.ticks||!e.allTicks)return;const n=performance.now();e.ticks=e.ticks.filter(r=>n-r.time<5e3);const i=Math.max(o.adrRange/1e4,e.maxObservedPrice-e.minObservedPrice),s=e.currentPrice-e.midPrice,m=i/2;s>m?e.midPrice=e.currentPrice-m:s<-m&&(e.midPrice=e.currentPrice+m),k(t),g();let c=new Map,a;if(o.distributionDepthMode==="all")a=e.allTicks;else{const r=Math.floor(e.allTicks.length*(o.distributionPercentage/100));a=e.allTicks.slice(Math.max(0,e.allTicks.length-r))}a.forEach(r=>{const u=Math.floor(r.price*(1e4/o.priceBucketSize));c.has(u)||c.set(u,{buy:0,sell:0,total:0});const d=c.get(u);r.direction>0?d.buy+=1:d.sell+=1,d.total+=1}),self.postMessage({type:"stateUpdate",payload:{currentPrice:e.currentPrice,lastTickDirection:e.lastTickDirection,maxDeflection:{...e.maxDeflection},volatility:e.volatility,midPrice:e.midPrice,minObservedPrice:e.minObservedPrice,maxObservedPrice:e.maxObservedPrice,marketProfile:c}})}function k(t){if(!e||!e.maxDeflection)return;const n=performance.now();n-e.maxDeflection.lastUpdateTime>o.maxMarkerDecay*1e3&&(e.maxDeflection.up=0,e.maxDeflection.down=0);let i=!1;t.direction>0&&t.magnitude>e.maxDeflection.up&&(e.maxDeflection.up=t.magnitude,i=!0),t.direction<0&&t.magnitude>e.maxDeflection.down&&(e.maxDeflection.down=t.magnitude,i=!0),i&&(e.maxDeflection.lastUpdateTime=n)}function g(){if(!e||!e.ticks)return;const t=5e3,n=performance.now();if(e.ticks=e.ticks.filter(a=>n-a.time<t),e.ticks.length<5){e.volatility*=.99;return}const i=e.ticks.map(a=>a.magnitude),s=i.reduce((a,r)=>a+r,0)/i.length,m=e.ticks.length/(t/1e3),c=s*.5+m*.5;e.volatility=e.volatility*.95+c*.05}self.onmessage=t=>{const{type:n,payload:i}=t.data;switch(n){case"init":o=i.config,e=i.initialState||{},console.log("Worker received init message. Payload:",i,"State after assignment:",e),e.lastTickTime||(e.lastTickTime=performance.now()),e.currentPrice||(e.currentPrice=1),e.midPrice||(e.midPrice=1),e.minObservedPrice||(e.minObservedPrice=1),e.maxObservedPrice||(e.maxObservedPrice=1),e.ticks||(e.ticks=[]),e.allTicks||(e.allTicks=[]),e.maxDeflection||(e.maxDeflection={up:0,down:0,lastUpdateTime:0}),e.volatility||(e.volatility=.5),e.momentum||(e.momentum=0);break;case"startSimulation":l&&clearInterval(l),l=setInterval(v,50);break;case"updateConfig":o={...o,...i};break;case"stop":l&&clearInterval(l);break}}})();
